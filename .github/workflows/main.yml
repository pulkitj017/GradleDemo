name: Gradle SBOM Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Upload project artifact
        uses: actions/upload-artifact@v4
        with:
          name: project
          path: .

  sbom_scan:
    runs-on: ubuntu-22.04
    needs: build
    steps:
      - name: Download project artifact
        uses: actions/download-artifact@v4
        with:
          name: project

      - name: Remove preinstalled Java (JDK 11) and Gradle
        run: |
          sudo apt-get purge -y openjdk-11-*
          sudo apt-get autoremove -y
          sudo rm -rf /usr/share/gradle
          sudo rm -rf /usr/local/gradle
          sudo rm -rf /opt/hostedtoolcache/gradle
          which java && java -version || echo "Java removed"
          which gradle && gradle -v || echo "Gradle removed"
      
      - name: Install Java 17
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jdk
          echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
          echo "/usr/lib/jvm/java-17-openjdk-amd64/bin" >> $GITHUB_PATH
          java -version
      
      - name: Install Gradle 7.0.2
        run: |
          wget https://services.gradle.org/distributions/gradle-7.0.2-bin.zip
          unzip -q gradle-7.0.2-bin.zip
          sudo mv gradle-7.0.2 /opt/gradle
          echo "/opt/gradle/bin" >> $GITHUB_PATH
          gradle -v
          chmod +x gradlew
          ./gradlew build
          


      - name: Run get-details-1.sh
        run: |
          chmod +x gradlew
          bash ./get-details-1.sh
          echo "After get-details-1.sh:"
          ls -l

      - name: Run get-details-2.sh
        run: |
          ls -l dependency-updates
          cat dependency-updates/report.txt
          cat outdated.txt
          cat outdated_dependencies_report.txt
          bash ./get-details-2.sh
          echo "After get-details-2.sh:"
          ls -l

      - name: Install PowerShell and run merge-details.ps1
        run: |
          wget https://github.com/PowerShell/PowerShell/releases/download/v7.5.0/powershell_7.5.0-1.deb_amd64.deb
          sudo dpkg -i powershell_7.5.0-1.deb_amd64.deb || true
          sudo apt --fix-broken install -y
          pwsh --version
          rm -rf powershell_7.5.0-1.deb_amd64.deb
          pwsh -File ./merge-details.ps1
          echo "After merge-details.ps1:"
          ls -l
          cat sbom-result.txt || echo "sbom-result.txt not found"

      - name: Run Trivy Scan
        run: |
          bash ./trivy.sh
          echo "After trivy.sh:"
          ls -l
          cat trivy-vulnerabilities.txt || echo "trivy-vulnerabilities.txt not found"

      - name: Upload Trivy Vulnerabilities
        uses: actions/upload-artifact@v4
        with:
          name: trivy-vulnerabilities
          path: trivy-vulnerabilities.txt

      - name: Upload SBOM Result
        uses: actions/upload-artifact@v4
        with:
          name: sbom-result
          path: sbom-result.txt
